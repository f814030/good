<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <script>
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.addEventListener('keydown', function(e) {
            if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I') || (e.ctrlKey && e.key === 'u')) {
                e.preventDefault();
            }
        });
    </script>

    <meta charset="UTF-8">
    <meta name="description" content="å¡­ä»”åœ³é‡åŠƒå€æ¨æ¡ˆé€²åº¦èˆ‡åœŸåœ°åˆ†é…åœ–ï¼Œæ–°èŠæ³°å±±å¡­ä»”åœ³æœ€æ–°æ¨æ¡ˆåœ°åœ–ã€ç¤¾å®…é å®šåœ°ã€æŠµè²»åœ°ã€å…¬åœ’ç”¨åœ°å³æ™‚æŸ¥è©¢ï¼Œå”åŠ©æŒæ¡æŠ•è³‡èˆ‡è³¼å±‹æ±ºç­–ã€‚">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-LVXHSZW7HT"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());
        gtag('config', 'G-LVXHSZW7HT');
    </script>

    <title>ğŸ“ æ–°èŠæ³°å±±å¡­ä»”åœ³æ¨æ¡ˆèˆ‡åœŸåœ°åˆ†é…åœ°åœ– ğŸ“</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        html,
        body {
            margin: 0;
            height: 100%;
        }

        #map {
            width: 100%;
            height: 100%;
        }
		/* è®“å“ç‰Œ icon ä»¥ã€Œåº•éƒ¨ä¸­å¤®ã€ç‚ºç¸®æ”¾ä¸­å¿ƒï¼Œç¸®æ”¾æ›´è‡ªç„¶ */
		.brand-icon {
		  transform-origin: 50% 100%;
		  transition: transform 120ms ease-out; /* ç¸®æ”¾æ›´é † */
		}
    </style>
</head>

<body>
    <div style="display:none;">
        å¡­ä»”åœ³æ¨æ¡ˆåœ°åœ–ã€æ–°èŠæ³°å±±åœŸåœ°åˆ†é…åœ–ã€å¡­ä»”åœ³å»ºæ¡ˆåœ°åœ–ã€å¡­ä»”åœ³é‡åŠƒå€æ¨æ¡ˆé€²åº¦ã€ç¤¾å®…é å®šåœ°æŸ¥è©¢ã€æŠµè²»åœ°æŸ¥è©¢ã€å…¬åœ’ç”¨åœ°æŸ¥è©¢ã€å¡­å­åœ³ã€æº«å­åœ³
    </div>

    <a id="bottomBar" onclick="gtag('event', 'click', {'event_category': 'button', 'event_label': 'LINEç¾¤é‚€è«‹é»æ“Š' });" href="https://line.me/ti/g2/2CsG8s2znH7ZG4v9zZd1hG8Imb66ABHCPEBKdg?utm_source=invitation&utm_medium=link_copy&utm_campaign=default" target="_blank">ğŸ“± é»æ­¤åŠ å…¥å¡­ä»”åœ³å»ºæ¡ˆ LINE ç¤¾ç¾¤æŒæ¡æœ€æ–°è³‡è¨Š</a>
    <style>
        #bottomBar {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: #00c300;
            color: white;
            padding: 8px 15px;
            border-radius: 50px;
            font-size: 14px;
            text-decoration: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            z-index: 999;
        }
    </style>

    <div id="searchBar" style="position:fixed;top:15px;left:50%;transform:translateX(-50%);z-index:9999;background:rgba(255,255,255,0.96);border-radius:10px;padding:8px 12px 6px 12px;box-shadow:0 2px 6px rgba(0,0,0,0.08);display:flex;gap:10px;">
        <input type="text" id="managerSearch" placeholder="è¼¸å…¥ç®¡ç†äººé—œéµå­—..." style="font-size:15px;padding:3px 8px;">
        <button id="clearHighlight" style="background:#FFD600;color:#333;font-weight:bold;border:none;border-radius:6px;padding:3px 14px;cursor:pointer;">æ¸…é™¤</button>
    </div>

    <div id="map"></div>
    <script>
        var map = L.map('map').setView([25.0403, 121.4358], 16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 20,attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

		// ä¾ zoom ç®—ç¸®æ”¾å€ç‡ï¼ˆå¯èª¿æ•´é€™äº›åƒæ•¸ï¼‰
		const SCALE_CONFIG = {
		  baseZoom: 16,  // åœ¨é€™å€‹ç¸®æ”¾ç­‰ç´šæ™‚ï¼Œå€ç‡=1
		  step: 0.2,     // æ¯å¤š/å°‘ 1 ç´š zoomï¼Œå€ç‡å¢æ¸›å¤šå°‘
		  min: 0.5,      // æœ€å°ç¸®æ”¾å€ç‡
		  max: 1.3       // æœ€å¤§ç¸®æ”¾å€ç‡
		};
		function clamp(x, a, b){ return Math.max(a, Math.min(b, x)); }
		function scaleForZoom(z){
		  const s = 1 + (z - SCALE_CONFIG.baseZoom) * SCALE_CONFIG.step;
		  return +clamp(s, SCALE_CONFIG.min, SCALE_CONFIG.max).toFixed(2);
		}

		// å°ä¾¿åˆ©å•†åº—åœ–å±¤å¥—ç”¨ç¸®æ”¾
		function applyMarkerScale(){
		  if (!window.convenienceLayer) return;
		  const s = scaleForZoom(map.getZoom());
		  convenienceLayer.eachLayer(mk => {
		    const el = mk.getElement && mk.getElement();
		    if (el) el.style.transform = `scale(${s})`;
		  });
		}

        function getColor(feature) {
            if (feature.properties && feature.properties.color) {
                return feature.properties.color;
            }
            return '#90aaad';
        }
        function stripMask(str) { return (str || '').replace(/[â—‹ï¼Šâ—_]/g, ''); }

	    let polygonsLayer;     // é¢å±¤ï¼ˆ./data/map.geojsonï¼‰
	    let convenienceLayer;  // é»å±¤ï¼ˆ./data/convenience.geojsonï¼‰
	    let layerControl;      // åœ–å±¤æ§åˆ¶å™¨
        window._highlightedLayers = [];
        window._featureLayers = [];

	    // ====== å“ç‰Œåœ–ç¤ºï¼ˆè«‹æ”¾ç½®å°æ‡‰æª”æ¡ˆï¼š./img/brands/*.pngï¼‰ ======
	    function normalizeBrand(b) {
	      return (b || '').toString().trim().toLowerCase().replace(/[^\w]/g, '');
	    }
	    const BRAND_ALIASES = {
	      '7eleven':    ['7-eleven','7_11','7eleven','çµ±ä¸€è¶…å•†','seven'],
	      'familymart': ['familymart','å…¨å®¶','å…¨å®¶ä¾¿åˆ©å•†åº—'],
	      'hilife':     ['hi-life','hilife','èŠçˆ¾å¯Œ'],
	      'okmart':     ['ok','okmart','okè¶…å•†']
	    };
	    function brandKeyFrom(raw) {
	      const norm = normalizeBrand(raw);
	      if (['7eleven','familymart','hilife','okmart'].includes(norm)) return norm;
	      for (const k in BRAND_ALIASES) {
	        if (BRAND_ALIASES[k].some(a => normalizeBrand(a) === norm)) return k;
	      }
	      return null;
	    }
		const BRAND_ICONS = {
		  '7eleven': L.icon({
		    iconUrl: './img/brands/7eleven.png',
		    iconSize: [28, 28],
		    iconAnchor: [14, 28],
		    popupAnchor: [0, -24],
		    className: 'brand-icon'
		  }),
		  'familymart': L.icon({
		    iconUrl: './img/brands/familymart.png',
		    iconSize: [28, 28],
		    iconAnchor: [14, 28],
		    popupAnchor: [0, -24],
		    className: 'brand-icon'
		  }),
		  'hilife': L.icon({
		    iconUrl: './img/brands/hilife.png',
		    iconSize: [28, 28],
		    iconAnchor: [14, 28],
		    popupAnchor: [0, -24],
		    className: 'brand-icon'
		  }),
		  'okmart': L.icon({
		    iconUrl: './img/brands/okmart.png',
		    iconSize: [28, 28],
		    iconAnchor: [14, 28],
		    popupAnchor: [0, -24],
		    className: 'brand-icon'
		  })
		};
	    const FALLBACK_ICON = L.divIcon({ html: 'ğŸª', className: 'store-icon', iconSize: [24,24], iconAnchor: [12,12] });

	    // ====== åœ–å±¤æ§åˆ¶å™¨ï¼šç­‰å…©å€‹å±¤éƒ½è¼‰å®Œå†å®‰è£ ======
	    function tryAddLayerControl() {
	      if (layerControl) { // å·²å­˜åœ¨å°±æ›´æ–°åœ–å±¤é›†åˆ
	        layerControl.remove();
	        layerControl = null;
	      }
	      if (polygonsLayer || convenienceLayer) {
	        layerControl = L.control.layers(
	          null,
	          {
	            //'åœŸåœ°åˆ†é…': polygonsLayer || L.layerGroup(),(æš«æ™‚é—œé–‰)
	            'ä¾¿åˆ©å•†åº—': convenienceLayer || L.layerGroup()
	          },
	          { collapsed: false }
	        ).addTo(map);
	      }
	    }

        fetch('./data/map.geojson', { cache: 'no-store' })
            .then(response => response.json())
            .then(data => {
                polygonsLayer  = L.geoJSON(data, {
                    style: function(feature) {
                        let styleObj = {
                            color: getColor(feature),
                            weight: 1,
                            fillOpacity: 0.6,
                            fillColor: getColor(feature)
                        };
                        if (feature.properties && feature.properties.ç®¡ç†äºº === "ç¤¾å®…é å®šåœ°") {
                            styleObj.fillColor = "#B39DDB";
                            styleObj.color = "#5E35B1";
                        }
                        if (feature.properties && feature.properties.ç”¨é€” === "æ©Ÿæ·æ³°å±±ç«™") {
                            styleObj.fillColor = "#868686";
                            styleObj.color = "#3c00ea";
                            styleObj.weight = 4;
                        }
                        if (feature.properties && feature.properties.ç”¨é€” === "è¼”å¤§æ·é‹ç«™4è™Ÿå‡ºå£") {
                            styleObj.fillColor = "#868686";
                            styleObj.color = "#3c00ea";
                            styleObj.weight = 4;
                        }
                        if (feature.properties && feature.properties.ç”¨é€” === "æ©Ÿæ·è²´å’Œç«™") {
                            styleObj.fillColor = "#868686";
                            styleObj.color = "#3c00ea";
                            styleObj.weight = 4;
                        }
                        return styleObj;
                    },
                    onEachFeature: function(feature, layer) {

                        // ----- é»æ“Šè‰²å¡Šç”¢ç”ŸåŒå¿ƒåœ“èˆ‡æ¨™ç±¤ -----
                        layer.on('click', function(e) {
                            // 1. å…ˆç§»é™¤èˆŠåœ“å’ŒèˆŠæ¨™ç±¤/æŒ‰éˆ•
                            if (window._bufferCircle300) map.removeLayer(window._bufferCircle300);
                            if (window._bufferCircle500) map.removeLayer(window._bufferCircle500);
                            if (window._bufferCircleLabel300) map.removeLayer(window._bufferCircleLabel300);
                            if (window._bufferCircleLabel500) map.removeLayer(window._bufferCircleLabel500);
                            if (window._bufferCircleClearBtn) map.removeLayer(window._bufferCircleClearBtn);
                            // 2. è¨ˆç®—å½¢å¿ƒ
                            var latlngs = feature.geometry.coordinates[0].map(function(coord) {
                                return [coord[1], coord[0]];
                            });
                            var bounds = L.latLngBounds(latlngs);
                            var center = bounds.getCenter();

                            // ç•«åœ“
                            window._bufferCircle300 = L.circle(center, {
                                color: '#43a047',
                                fillColor: '#b9f6ca',
                                fillOpacity: 0.3,
                                radius: 300,
                                interactive: false
                            }).addTo(map);
                            window._bufferCircle500 = L.circle(center, {
                                color: '#ffb300',
                                fillColor: '#ffe082',
                                fillOpacity: 0.2,
                                radius: 500,
                                interactive: false
                            }).addTo(map);

                            // ç·¯åº¦å¾€åŒ—åç§» meters å…¬å°º
                            function latOffset(center, meters) {
                                return center.lat + (meters / 111320);
                            }
                            // åœ“é ‚æ¨™ç±¤
                            window._bufferCircleLabel300 = L.marker(
                                [latOffset(center, 300), center.lng], {
                                    icon: L.divIcon({
                                        className: 'circle-label',
                                        html: '<div style="color:#388e3c; font-weight:bold; font-size:14px; background:rgba(255,255,255,0.85); border-radius:8px; padding:1px 8px; border:1px solid #43a047; display:inline-block; text-align:center;">300m</div>',
                                        iconSize: [48, 22],
                                        iconAnchor: [24, 11]
                                    }),
                                    interactive: false
                                }
                            ).addTo(map);

                            window._bufferCircleLabel500 = L.marker(
                                [latOffset(center, 500), center.lng], {
                                    icon: L.divIcon({
                                        className: 'circle-label',
                                        html: '<div style="color:#ff6f00; font-weight:bold; font-size:14px; background:rgba(255,255,255,0.85); border-radius:8px; padding:1px 8px; border:1px solid #ffb300; display:inline-block; text-align:center;">500m</div>',
                                        iconSize: [48, 22],
                                        iconAnchor: [24, 11]
                                    }),
                                    interactive: false
                                }
                            ).addTo(map);

                            // --- ç”¢ç”Ÿåœ“é ‚å³å´ã€Œæ¸…é™¤åŒå¿ƒåœ“ã€æŒ‰éˆ• ---
                            if (window._bufferCircleClearBtn) map.removeLayer(window._bufferCircleClearBtn);
                            window._bufferCircleClearBtn = L.marker(
                                [latOffset(center, 500) + 0.00025, center.lng + 0.0014], { // ä¸Šç§»ç´„20å…¬å°ºï¼Œå³ç§»
                                    icon: L.divIcon({
                                        className: 'circle-clear-btn',
                                        html: '<button title="åªæ¸…é™¤åŒå¿ƒåœ“" onclick="window.removeCircles();" style="background:#fff;color:#ff6f00;font-weight:bold;border:1px solid #ffb300;border-radius:12px;padding:2px 12px;font-size:13px;cursor:pointer;box-shadow:0 1px 4px rgba(0,0,0,0.08);">æ¸…é™¤</button>',
                                        iconSize: [52, 28],
                                        iconAnchor: [26, 14]
                                    }),
                                    interactive: true
                                }
                            ).addTo(map);

                            // å…¨åŸŸåˆªé™¤åœ“åœˆåŠŸèƒ½
                            window.removeCircles = function() {
                                if (window._bufferCircle300) map.removeLayer(window._bufferCircle300);
                                if (window._bufferCircle500) map.removeLayer(window._bufferCircle500);
                                if (window._bufferCircleLabel300) map.removeLayer(window._bufferCircleLabel300);
                                if (window._bufferCircleLabel500) map.removeLayer(window._bufferCircleLabel500);
                                if (window._bufferCircleClearBtn) map.removeLayer(window._bufferCircleClearBtn);
                            };

                            // è‡ªå‹•å¹³ç§»åœ°åœ–ï¼ˆå½¢å¿ƒå‘åŒ—åç§»ï¼‰
                            map.panTo([center.lat + 0.0015, center.lng]);
                        });
							
							// --- popup å…§å®¹ï¼ˆå«åœ–ç‰‡ï¼‰ ---
                        var props = feature.properties;
                        var info = '';
                        for (var key in props) {
                            if (key !== 'color' && key !== 'åœ–ç‰‡') {
                                info += key + ': ' + props[key] + '<br>';
                            }
                        }
                        if (props.åœ–ç‰‡) {
                            info += '<img src="' + props.åœ–ç‰‡ + '" style="max-width:150px; margin-top:5px;">';
                        }
                        layer.bindPopup(info);

                        layer.on("popupopen", function(e) {
                            var popup = e.popup;
                            var images = popup.getElement().querySelectorAll("img");
                            images.forEach(function(img) {
                                img.addEventListener("load", function() {
                                    popup.update();
                                });
                            });
                        });
						
						// --- emoji ä¸­å¤®æ¨™è¨˜ï¼ˆä¾ç”¨é€”/ç®¡ç†äººï¼‰ ---
                        if (feature.geometry.type === "Polygon") {
                            var latlngs = feature.geometry.coordinates[0].map(function(coord) {
                                return [coord[1], coord[0]];
                            });
                            var bounds = L.latLngBounds(latlngs);
                            var center = bounds.getCenter();
                            var emoji = "";
                            if (feature.properties.ç”¨é€” === "ç¤¾å®…é å®šåœ°") {
                                emoji = "ğŸ ";
                            } else if (feature.properties.ç‹€æ…‹ === "èˆˆå»ºä¸­") {
                                emoji = "ğŸ—ï¸";
                            } else if (feature.properties.ç®¡ç†äºº === "æ•™è‚²å±€") {
                                emoji = "ğŸ«";
                            } else if (feature.properties.ç”¨é€” === "è®Šé›»æ‰€ç”¨åœ°") {
                                emoji = "âš¡";
                            } else if (feature.properties.ç®¡ç†äºº === "æ’é™¤é‡åŠƒ") {
                                emoji = "ğŸš«";
                            } else if (feature.properties.ç”¨é€” === "è¡Œäººä¾¿é“") {
                                emoji = "ğŸš¶â€â™€";
                            }

                            if (emoji !== "") {
                                var icon = L.divIcon({
                                    html: '<div style="font-size: 14px;">' + emoji + '</div>',
                                    className: "",
                                    iconSize: [24, 24]
                                });
                                L.marker(center, {
                                    icon: icon
                                }).addTo(map);
                            }
                        }
						
						// --- é»æ“Šé«˜äº®ï¼ˆ1 ç§’ï¼‰ ---
                        layer.on('click', function(e) {
                            layer.setStyle({
                                weight: 3,
                                color: '#FFFF00',
                                fillOpacity: 0.7
                            });
                            setTimeout(function() {
                                layer.setStyle({
                                    weight: 1,
                                    color: getColor(feature),
                                    fillOpacity: 0.5
                                });
                            }, 1000);
                        });
                    }
                }).addTo(map);
		        // æ”¶é›†å¯é«˜äº®çš„ polygon åœ–å±¤ï¼ˆä¾›æœå°‹ï¼‰
		        collectFeatureLayers();
		        tryAddLayerControl();
            })
            .catch(error => console.error('map.GeoJSON åŠ è¼‰å¤±æ•—:', error));
		
		// ====== è¼‰å…¥ã€Œä¾¿åˆ©å•†åº—é»ä½ã€GeoJSONï¼ˆ./data/convenience.geojsonï¼‰ ======
	    fetch('./data/convenience.geojson', { cache: 'no-store' })
	      .then(r => r.json())
	      .then(pts => {
	        convenienceLayer = L.geoJSON(pts, {
	          pointToLayer: (feature, latlng) => {
	            const p = feature.properties || {};
	            const key = brandKeyFrom(p.å“ç‰Œ ?? p.brand ?? '');
	            const icon = key ? BRAND_ICONS[key] : FALLBACK_ICON;
	            return L.marker(latlng, { icon });
	          },
	          onEachFeature: (feature, layer) => {
	            const p = feature.properties || {};
	            layer.bindPopup(
	              `<b>${p.åç¨± || p.name || 'ä¾¿åˆ©å•†åº—'}</b>` +
	              (p.å“ç‰Œ || p.brand ? `<br>å“ç‰Œï¼š${p.å“ç‰Œ || p.brand}` : '') +
	              (p.åœ°å€ || p.address ? `<br>åœ°å€ï¼š${p.åœ°å€ || p.address}` : '')
	            );
	          }
	        }).addTo(map);
			applyMarkerScale();
	        tryAddLayerControl();
	      })
	      	.catch(err => console.error('convenience.geojson è¼‰å…¥å¤±æ•—ï¼š', err));
			// ====== è®“å“ç‰Œ icon æœƒè·Ÿè‘—åœ°åœ–ç¸®æ”¾ ======
			map.whenReady(applyMarkerScale);   // åœ°åœ–è¼‰å¥½å…ˆå¥—ä¸€æ¬¡
			map.on('zoom', applyMarkerScale);  // ç¸®æ”¾éç¨‹ä¸­å³æ™‚ç¸®æ”¾ icon

			// å¾åœ–å±¤æ§åˆ¶å™¨æŠŠã€Œä¾¿åˆ©å•†åº—ã€æ‰“é–‹æ™‚ï¼Œå†å¥—ä¸€æ¬¡
			map.on('overlayadd', (e) => {
			  if (e.layer === convenienceLayer) applyMarkerScale();
			});

			// å…¶ä»–æƒ…æ³æœ‰ marker è¢«åŠ å…¥åœ°åœ–æ™‚ï¼ˆä¿éšªï¼‰
			map.on('layeradd', (e) => {
			  if (e.layer && e.layer.getElement) applyMarkerScale();
			});
    </script>

    <script>
        // ==== ç®¡ç†äººé«˜äº®æœå°‹åŠŸèƒ½ï¼ˆåªå½±éŸ¿ polygonï¼‰ ====
        function stripMask(str) {
            return (str || "").replace(/[â—‹ï¼Šâ—_]/g, "");
        }

        // æ”¶é›†æ‰€æœ‰ geojson åœ–å±¤ï¼ˆéœ€åœ¨ geojson è¼‰å…¥å¾Œå‘¼å«ï¼‰
	    function collectFeatureLayers() {
	      window._featureLayers = [];
	      map.eachLayer(function(layer) {
	        if (layer.feature &&
	            layer.feature.properties &&
	            layer.setStyle &&
	            (layer.feature.geometry.type === 'Polygon' || layer.feature.geometry.type === 'MultiPolygon')) {
	          window._featureLayers.push({ feature: layer.feature, layer: layer });
	        }
	      });
	    }

        // å‘¼å«ä¸€æ¬¡ä»¥æ”¶é›†
        setTimeout(collectFeatureLayers, 1000); // ç¢ºä¿ geojson è¼‰å…¥å®Œæˆ

	    function highlightSearchedPolygons(keyword) {
	      window._highlightedLayers.forEach(obj => {
	        obj.layer.setStyle({ weight: 1, color: getColor(obj.feature), fillOpacity: 0.6, opacity: 1 });
	      });
	      window._highlightedLayers = [];
	      if (!keyword) return;
	      window._featureLayers.forEach(function(obj) {
	        const m = obj.feature.properties.ç®¡ç†äºº || '';
	        if (stripMask(m).indexOf(stripMask(keyword)) !== -1) {
	          obj.layer.setStyle({ color: '#FF00EA', weight: 5, fillOpacity: 0.85, opacity: 1 });
	          window._highlightedLayers.push(obj);
	        } else {
	          obj.layer.setStyle({ weight: 1, color: getColor(obj.feature), fillOpacity: 0.6, opacity: 1 });
	        }
	      });
	    }

        document.getElementById('managerSearch').addEventListener('input', function(e) {
            highlightSearchedPolygons(e.target.value.trim());
        });

        document.getElementById('clearHighlight').addEventListener('click', function() {
            window._highlightedLayers.forEach(obj => {
                obj.layer.setStyle({
                    weight: 1,
                    color: getColor(obj.feature),
                    fillOpacity: 0.6,
                    opacity: 1
                });
            });
            window._highlightedLayers = [];
            document.getElementById('managerSearch').value = '';
        });
    </script>

</body>

</html>