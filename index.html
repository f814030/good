<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<script>
document.addEventListener('contextmenu', event => event.preventDefault());
document.addEventListener('keydown', function(e) {
  if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I') || (e.ctrlKey && e.key === 'u')) {
    e.preventDefault();
  }
});
</script>

<meta charset="UTF-8">
<meta name="description" content="å¡­ä»”åœ³é‡åŠƒå€æ¨æ¡ˆé€²åº¦èˆ‡åœŸåœ°åˆ†é…åœ–ï¼Œæ–°èŠæ³°å±±å¡­ä»”åœ³æœ€æ–°æ¨æ¡ˆåœ°åœ–ã€ç¤¾å®…é å®šåœ°ã€æŠµè²»åœ°ã€å…¬åœ’ç”¨åœ°å³æ™‚æŸ¥è©¢ï¼Œå”åŠ©æŒæ¡æŠ•è³‡èˆ‡è³¼å±‹æ±ºç­–ã€‚">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LVXHSZW7HT"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-LVXHSZW7HT');
</script>

<title>ğŸ“ æ–°èŠæ³°å±±å¡­ä»”åœ³æ¨æ¡ˆèˆ‡åœŸåœ°åˆ†é…åœ°åœ– ğŸ“</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<style>html, body { margin:0; height:100%; } #map { width: 100%; height: 100%; }</style>
</head>
<body>
<div style="display:none;">
å¡­ä»”åœ³æ¨æ¡ˆåœ°åœ–ã€æ–°èŠæ³°å±±åœŸåœ°åˆ†é…åœ–ã€å¡­ä»”åœ³å»ºæ¡ˆåœ°åœ–ã€å¡­ä»”åœ³é‡åŠƒå€æ¨æ¡ˆé€²åº¦ã€ç¤¾å®…é å®šåœ°æŸ¥è©¢ã€æŠµè²»åœ°æŸ¥è©¢ã€å…¬åœ’ç”¨åœ°æŸ¥è©¢ã€å¡­å­åœ³ã€æº«å­åœ³
</div>

<a id="bottomBar" onclick="gtag('event', 'click', {'event_category': 'button', 'event_label': 'LINEç¾¤é‚€è«‹é»æ“Š' });" href="https://line.me/ti/g2/2CsG8s2znH7ZG4v9zZd1hG8Imb66ABHCPEBKdg?utm_source=invitation&utm_medium=link_copy&utm_campaign=default" target="_blank">ğŸ“± é»æ­¤åŠ å…¥å¡­ä»”åœ³å»ºæ¡ˆ LINE ç¤¾ç¾¤æŒæ¡æœ€æ–°è³‡è¨Š</a>
<style>
#bottomBar {
  position: fixed;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  background: #00c300;
  color: white;
  padding: 8px 15px;
  border-radius: 50px;
  font-size: 14px;
  text-decoration: none;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  z-index: 999;
}
</style>

<div id="map"></div>
<script>
var map = L.map('map').setView([25.0403, 121.4358], 16);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 20,
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

function getColor(feature) {
    if (feature.properties && feature.properties.color) {
        return feature.properties.color;
    }
    return '#90aaad';
}

fetch('school.geojson')
  .then(response => response.json())
  .then(data => {
    L.geoJSON(data, {
      style: function(feature) {
        let styleObj = {
          color: getColor(feature),
          weight: 1,
          fillOpacity: 0.6,
          fillColor: getColor(feature)
        };
        if (feature.properties && feature.properties.ç®¡ç†äºº === "ç¤¾å®…é å®šåœ°") {
            styleObj.fillColor = "#B39DDB";
            styleObj.color = "#5E35B1";
        }
        if (feature.properties && feature.properties.ç”¨é€” === "æ©Ÿæ·æ³°å±±ç«™") {
            styleObj.fillColor = "#868686";
            styleObj.color = "#3c00ea";
            styleObj.weight = 4;
        }
        if (feature.properties && feature.properties.ç”¨é€” === "è¼”å¤§æ·é‹ç«™4è™Ÿå‡ºå£") {
            styleObj.fillColor = "#868686";
            styleObj.color = "#3c00ea";
            styleObj.weight = 4;
        }
        if (feature.properties && feature.properties.ç”¨é€” === "æ©Ÿæ·è²´å’Œç«™") {
            styleObj.fillColor = "#868686";
            styleObj.color = "#3c00ea";
            styleObj.weight = 4;
        }
        return styleObj;
      },
      onEachFeature: function(feature, layer) {
// --------- é»æ“Šè‰²å¡Šç•«åŒå¿ƒåœ“ä¸¦åŠ ä¸Šæ¨™ç±¤ -----------
layer.on('click', function(e) {
    // 1. å…ˆç§»é™¤èˆŠåœ“èˆ‡èˆŠæ¨™ç±¤
    if(window._bufferCircle300) map.removeLayer(window._bufferCircle300);
    if(window._bufferCircle500) map.removeLayer(window._bufferCircle500);
    if(window._bufferCircleLabel300) map.removeLayer(window._bufferCircleLabel300);
    if(window._bufferCircleLabel500) map.removeLayer(window._bufferCircleLabel500);

    // 2. è¨ˆç®—å½¢å¿ƒ
    var latlngs = feature.geometry.coordinates[0].map(function(coord) {
        return [coord[1], coord[0]];
    });
    var bounds = L.latLngBounds(latlngs);
    var center = bounds.getCenter();

    // ç•« 300mã€500m åœ“ï¼ˆä¸äº’å‹•ï¼‰
    window._bufferCircle300 = L.circle(center, {
        color: '#43a047',
        fillColor: '#b9f6ca',
        fillOpacity: 0.3,
        radius: 300,
        interactive: false
    }).addTo(map);
    window._bufferCircle500 = L.circle(center, {
        color: '#ffb300',
        fillColor: '#ffe082',
        fillOpacity: 0.2,
        radius: 500,
        interactive: false
    }).addTo(map);

    // å–ç·¯åº¦å¾€åŒ—åç§» meters å…¬å°º
    function latOffset(center, meters) {
        return center.lat + (meters / 111320);
    }
    // åœ“é ‚æ¨™ç±¤
    window._bufferCircleLabel300 = L.marker(
        [latOffset(center, 300), center.lng],
        {
            icon: L.divIcon({
                className: 'circle-label',
                html: '<div style="color:#388e3c; font-weight:bold; font-size:16px; background:rgba(255,255,255,0.85); border-radius:8px; padding:1px 8px; border:1px solid #43a047;">300m</div>',
                iconSize: [40, 20],
                iconAnchor: [20, 10]
            }),
            interactive: false
        }
    ).addTo(map);

    window._bufferCircleLabel500 = L.marker(
        [latOffset(center, 500), center.lng],
        {
            icon: L.divIcon({
                className: 'circle-label',
                html: '<div style="color:#ff6f00; font-weight:bold; font-size:16px; background:rgba(255,255,255,0.85); border-radius:8px; padding:1px 8px; border:1px solid #ffb300;">500m</div>',
                iconSize: [40, 20],
                iconAnchor: [20, 10]
            }),
            interactive: false
        }
    ).addTo(map);

    // 4. åœ°åœ–å¹³ç§»ï¼ˆå½¢å¿ƒå‘åŒ—åç§»ï¼‰
    map.panTo([center.lat + 0.0015, center.lng]);
});
// --------- åŒå¿ƒåœ“åŠŸèƒ½çµæŸ -----------

        var props = feature.properties;
        var info = '';
        for (var key in props) {
          if (key !== 'color' && key !== 'åœ–ç‰‡') {
            info += key + ': ' + props[key] + '<br>';
          }
        }
        if (props.åœ–ç‰‡) {
            info += '<img src="' + props.åœ–ç‰‡ + '" style="max-width:150px; margin-top:5px;">';
        }
        layer.bindPopup(info);
        
        // ä¿®æ­£å½ˆçª—åœ–ç‰‡é¦–æ¬¡é¡¯ç¤ºå°ºå¯¸å•é¡Œ
        layer.on("popupopen", function(e) {
            var popup = e.popup;
            var images = popup.getElement().querySelectorAll("img");
            images.forEach(function(img) {
                img.addEventListener("load", function() {
                    popup.update();
                });
            });
        });

		// ç–ŠåŠ  ICON é¡¯ç¤º
        if (feature.geometry.type === "Polygon") {
            var latlngs = feature.geometry.coordinates[0].map(function(coord) {
                return [coord[1], coord[0]];
            });
            var bounds = L.latLngBounds(latlngs);
            var center = bounds.getCenter();
            var emoji = "";
            if (feature.properties.ç”¨é€” === "ç¤¾å®…é å®šåœ°") {
                emoji = "ğŸ ";
            } else if (feature.properties.ç‹€æ…‹ === "èˆˆå»ºä¸­") {
                emoji = "ğŸ—ï¸";
            } else if (feature.properties.ç®¡ç†äºº === "æ•™è‚²å±€") {
                emoji = "ğŸ«";
            } else if (feature.properties.ç”¨é€” === "è®Šé›»æ‰€ç”¨åœ°") {
                emoji = "âš¡";
            } else if (feature.properties.ç®¡ç†äºº === "æ’é™¤é‡åŠƒ") {
                emoji = "ğŸš«";
            } else if (feature.properties.ç”¨é€” === "è¡Œäººä¾¿é“") {
                emoji = "ğŸš¶â€â™€";
            } 
            
            if (emoji !== "") {
                var icon = L.divIcon({
                    html: '<div style="font-size: 14px;">' + emoji + '</div>',
                    className: "",
                    iconSize: [24, 24]
                });
                L.marker(center, {icon: icon}).addTo(map);
            }
        }

        layer.on('click', function(e) {
          layer.setStyle({
            weight: 3,
            color: '#FFFF00',
            fillOpacity: 0.7
          });
          setTimeout(function() {
            layer.setStyle({
              weight: 1,
              color: getColor(feature),
              fillOpacity: 0.5
            });
          }, 1000);
        });
      }
    }).addTo(map);
  })
  .catch(error => console.error('GeoJSON åŠ è¼‰å¤±æ•—:', error));
</script>
</body>
</html>
